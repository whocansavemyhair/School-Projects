---
title: "Project2"
output: html_document
date: "2023-05-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load packages

```{r}
# Load libraries
library("tidyverse") # Lots of data processing commands
library("knitr")     # Helps make good output files
library("ggplot2")   # Output plots
library("rmarkdown") # Helps make good output files
library("lattice")   # Makes nice plots
library("RColorBrewer") # Makes nice color-scales
library("skimr")     # Summary statistics
library("Stat2Data") # Regression specific commands
library("corrplot")  # correlation plots
library("GGally")    # correlation plots
library("ggpubr")    # QQplots
library("olsrr")     # Regression specific commands
library("plotly")    # Interactive plots
library("ggstatsplot") # Make nice plots
library("visreg") #visualise regression outputs
library("MASS") # Studentised residuals
```



## PRSM

### 1. Read in the data

```{r}
loans <- read_csv("group1_training_data.csv")
```


### 2. Preprocess Data
```{r}
loans$WomanOwned <- factor(loans$WomanOwned)
loans$CorpStructure <- factor(loans$CorpStructure)
loans$NAICS <- factor(loans$NAICS)
```


```{r}
# show correlations between each variables
ggcorrmat(loans)
```


### 3. Fit the MLR model

As the corrleations plot shows, we will drop out the variables Num_CreditLines, Stress, Volume, Months.
And there is a strong correlation between FICO and Num_CreditLines, so we need drop out Num_Delinquent too.

```{r}
columns <- c(4, 5, 6, 7, 11)
loans <- loans[, -columns]
Model <- lm(PRSM ~ FICO + TotalAmtOwed + WomanOwned +
                          CorpStructure + NAICS, data = loans)
# Check linearity and equal variance
# plot the residuals
ols_plot_resid_fit(Model)
ols_plot_resid_stud(Model)
ols_plot_resid_stand(Model)
#Check normality
ols_plot_resid_hist(Model)
ols_test_normality(Model)
ols_plot_resid_qq(Model)

#Check for influential outliers
ols_plot_resid_lev(Model)
```


From the plot Outlier and Leverage Diagnostics for PRSM, we could find some outliers, now we will removed them.

### 4. Improve the model

```{r}
outliers <- c(686, 1769, 1196, 1012, 230, 1921, 1717, 2206, 1780, 2126,
              147, 1189, 472, 602, 1988, 547, 1678, 649, 2095,
              407, 1803, 1098, 1929, 1477, 986)
# remove outliers and leverages, and fit again
loans <- loans[-outliers, ]
Model <- lm(PRSM ~ FICO + TotalAmtOwed  + WomanOwned +
                          CorpStructure + NAICS, data = loans)
summary(Model)
```

Look at the NAICS variable, p-value of  most of them are greater than 0.01, so we consider 

divide them to 2 categories that NAICS444240 and non NAICS444240.

```{r}
loans$NAICS444240=as.factor(loans$NAICS=="444240")
Model <- lm(PRSM ~ FICO + TotalAmtOwed  + WomanOwned +
                          CorpStructure + NAICS444240, data = loans)
summary(Model)
```
The Estimate of FICO is 7.195e-04 means one-unit increase in FICO, we expect PRSM increase 7.195e-04

The Estimate of TotalAmtOwed is 4.913e-07 means one-unit increase in TotalAmtOwed, we expect PRSM increase 4.913e-07

The Estimate of WomanOwned1 is 2.760e-01 means if the bussiness is owned by woman, we expect PRSM increase 2.760e-1 compared to non Womanowned.

The Estimate of CorpStructureLLC is 2.213e-01 means CorpStruture is LLC will contribute 2.213e-01 to PRSM

The Estimate of CorpStructurePartner is 1.405e-01 means CorpStruture is Partner will contribute 1.405e-01 to PRSM

The Estimate of CorpStructureSole is -2.844e-02 means CorpStruture is Sole will decrease -2.844e-02 to PRSM

The Estimate of NAICS444240TRUE is 2.216e-02 means if NAICS is "444240", we expect PRSM increase 2.216e-02 compared to non "444240".

The Adjusted R-square is 0.8079, which means the model could explain 80.79%  of the variance is explained by the predictor variables.


```{r}

# Check Independence
ggcorrmat(loans)

# Check linearity and equal variance
# plot the residuals
ols_plot_resid_fit(Model)
ols_plot_resid_stud(Model)
ols_plot_resid_stand(Model)

#Check normality
ols_plot_resid_hist(Model)
ols_test_normality(Model)
ols_plot_resid_qq(Model)

```

Assess whether the model meets the LINE assumptions,

The correlation plot shows the variables are independent.

The Residual vs Fitted Values plot shows the Linearity and Equality of Variance are hold.

The Q-Q plot shows the Normality is hold.

Hence the new model meets LINE assumptions now.


### 5. Base Line

To introduce a base line, we will select the average of numeric variables and most frequent of categorical variables as our typical instance.

```{r}
FICO <- mean(loans$FICO)
TotalAmtOwed <- mean(loans$TotalAmtOwed)
WomanOwned <- names(which.max(table(loans$WomanOwned)))
CorpStructure <- names(which.max(table(loans$CorpStructure)))
NAICS <- names(which.max(table(loans$NAICS)))

typical <- data.frame(FICO,TotalAmtOwed, WomanOwned, CorpStructure, NAICS)
predict(Model, typical, interval="prediction", level=0.95)
```


### 5. Predict
```{r}
evaluations_data <- read_csv("installment2_evaluation_data.csv")
evaluations_data$CorpStructure <- factor(evaluations_data$CorpStructure)
evaluations_data$NAICS <- factor(evaluations_data$NAICS)
evaluations_data$NAICS444240 <- factor(evaluations_data$NAICS=="444240")
predictions <- predict(Model, evaluations_data, interval="prediction", level=0.95)
write_csv(as.data.frame(predictions), file = "predictions.csv")
```

